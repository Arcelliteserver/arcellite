# ───────────────────────────────────────────────────────────
# Arcellite — Docker Compose
# ───────────────────────────────────────────────────────────
# Deploy to /srv/arcellite/ on your server.
# Domain: cloud.arcelliteserver.com (port 3000)
#
# Uses your existing postgres-arcellite container.
# If you want a separate Postgres instance, see the
# commented-out service at the bottom.
#
# Quick start:
#   cd /srv/arcellite
#   docker compose up -d --build
# ───────────────────────────────────────────────────────────

services:
  arcellite:
    build: .
    container_name: arcellite
    restart: unless-stopped
    privileged: true
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - ARCELLITE_DATA=/data/arcellite-data

      # PostgreSQL — connects to existing postgres-arcellite container
      - DB_HOST=postgres-arcellite
      - DB_PORT=5432
      - DB_NAME=arcellite
      - DB_USER=arcellite_user
      - DB_PASSWORD=${DB_PASSWORD:-arcellite2024}

      # Session
      - SESSION_SECRET=${SESSION_SECRET:-7f9c8b2a4d3e1f0a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a}

      # Email (optional — set in .env)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_SECURE=${SMTP_SECURE:-true}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}

      # AI Email (optional — set in .env)
      - AI_SMTP_HOST=${AI_SMTP_HOST:-}
      - AI_SMTP_PORT=${AI_SMTP_PORT:-465}
      - AI_SMTP_SECURE=${AI_SMTP_SECURE:-true}
      - AI_SMTP_USER=${AI_SMTP_USER:-}
      - AI_SMTP_PASSWORD=${AI_SMTP_PASSWORD:-}
      - AI_SMTP_FROM=${AI_SMTP_FROM:-}
      - AI_NOREPLY_FROM=${AI_NOREPLY_FROM:-}

      # Timezone
      - TZ=America/New_York

      # MySQL/MariaDB — connects to mysql-arcellite container
      - MYSQL_HOST=mysql-arcellite
      - MYSQL_PORT=3306
      - MYSQL_USER=arcellite_user
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-arcellite2024}

    volumes:
      # Persistent storage: files, photos, videos, music, security keys
      - arcellite_data:/data/arcellite-data
      # Host USB/removable media access (for transfer & external storage)
      - /media:/media:rw
      - /run/media:/run/media:rw
      - /mnt:/mnt:rw
      - /dev:/dev:ro

    networks:
      - arcellite
      - postgres-net

  # MySQL/MariaDB for user-created MySQL databases
  mysql-arcellite:
    image: mariadb:11
    container_name: mysql-arcellite
    restart: unless-stopped
    environment:
      - MARIADB_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-arcellite_root2024}
      - MARIADB_USER=arcellite_user
      - MARIADB_PASSWORD=${MYSQL_PASSWORD:-arcellite2024}
    volumes:
      - arcellite_mysql:/var/lib/mysql
    networks:
      - arcellite

volumes:
  arcellite_data:
    driver: local
  arcellite_mysql:
    driver: local

networks:
  arcellite:
    driver: bridge
  postgres-net:
    external: true
    name: postgres_default

# ───────────────────────────────────────────────────────────
# If your existing postgres-arcellite is NOT on a shared
# Docker network, you have two options:
#
# Option A: Add postgres-arcellite to the postgres-net network
#   docker network create postgres-net
#   docker network connect postgres-net postgres-arcellite
#
# Option B: Uncomment below to run a dedicated Postgres
#   (and change DB_HOST above to arcellite-db)
# ───────────────────────────────────────────────────────────
#  arcellite-db:
#    image: postgres:15
#    container_name: arcellite-db
#    restart: unless-stopped
#    environment:
#      - POSTGRES_DB=arcellite
#      - POSTGRES_USER=arcellite_user
#      - POSTGRES_PASSWORD=${DB_PASSWORD:-arcellite2024}
#    volumes:
#      - arcellite_pgdata:/var/lib/postgresql/data
#    networks:
#      - arcellite
#
# And add to the volumes section:
#  arcellite_pgdata:
#    driver: local
